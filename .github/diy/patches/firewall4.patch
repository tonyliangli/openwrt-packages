From 0ec6236c18274caaa5e6b5802ac70a51f4134d32 Mon Sep 17 00:00:00 2001
From: Chen Minqiang <ptpt52@gmail.com>
Date: Sat, 19 Feb 2022 12:48:19 +0800
Subject: [PATCH] firewall4: script support

---
 package/network/config/firewall4/Makefile            |  3 +++
 .../network/config/firewall4/files/firewall.include  |  0
 .../firewall4/patches/100-fw4-support-script.patch   | 12 ++++++++++++
 .../firewall4/patches/200-fw4-hotplug-fork.patch     | 10 ++++++++++
 4 files changed, 25 insertions(+)
 create mode 100644 package/network/config/firewall4/files/firewall.include
 create mode 100644 package/network/config/firewall4/patches/100-fw4-support-script.patch
 create mode 100644 package/network/config/firewall4/patches/200-fw4-hotplug-fork.patch

diff --git a/package/network/config/firewall4/Makefile b/package/network/config/firewall4/Makefile
index 82f8fc6fb724e6..3696d78696a6da 100644
--- a/package/network/config/firewall4/Makefile
+++ b/package/network/config/firewall4/Makefile
@@ -38,10 +38,13 @@ endef
 define Package/firewall4/conffiles
 /etc/config/firewall
 /etc/nftables.d/
+/etc/firewall.include
 endef
 
 define Package/firewall4/install
 	$(CP) -a $(PKG_BUILD_DIR)/root/* $(1)/
+	$(INSTALL_DIR) $(1)/etc/
+	$(INSTALL_CONF) ./files/firewall.include $(1)/etc/firewall.include
 endef
 
 define Build/Compile
diff --git a/package/network/config/firewall4/files/firewall.include b/package/network/config/firewall4/files/firewall.include
new file mode 100644
index 00000000000000..e69de29bb2d1d6
diff --git a/package/network/config/firewall4/patches/100-fw4-support-script.patch b/package/network/config/firewall4/patches/100-fw4-support-script.patch
new file mode 100644
index 00000000000000..9dd6208392e2fd
--- /dev/null
+++ b/package/network/config/firewall4/patches/100-fw4-support-script.patch
@@ -0,0 +1,12 @@
+diff --git a/root/sbin/fw4 b/root/sbin/fw4
+index 3e7388b..4952ed0 100755
+--- a/root/sbin/fw4
++++ b/root/sbin/fw4
+@@ -33,6 +33,7 @@ start() {
+ 		ACTION=start \
+ 			ucode -S -i $MAIN | nft $VERBOSE -f /proc/self/fd/0
+ 	} 1000>$LOCK
++	test -f /etc/firewall.include && sh /etc/firewall.include
+ }
+ 
+ print() {
diff --git a/package/network/config/firewall4/patches/200-fw4-hotplug-fork.patch b/package/network/config/firewall4/patches/200-fw4-hotplug-fork.patch
new file mode 100644
index 00000000000000..7594291ce16c72
--- /dev/null
+++ b/package/network/config/firewall4/patches/200-fw4-hotplug-fork.patch
@@ -0,0 +1,10 @@
+diff --git a/root/etc/hotplug.d/iface/20-firewall b/root/etc/hotplug.d/iface/20-firewall
+index d0f030b..9a8132c 100644
+--- a/root/etc/hotplug.d/iface/20-firewall
++++ b/root/etc/hotplug.d/iface/20-firewall
+@@ -14,4 +14,4 @@ has_zone() {
+ has_zone || exit 0
+ 
+ logger -t firewall "Reloading firewall due to $ACTION of $INTERFACE ($DEVICE)"
+-fw4 -q reload
++fw4 -q reload &
